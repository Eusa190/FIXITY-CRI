<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>CRI Map | Fixity</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
    <style>
        #map { height: 70vh; border-radius: 12px; margin-top: 20px; }
        .controls { background: white; padding: 20px; border-radius: 12px; margin-top: 20px; }
    </style>
</head>
<body>
    <nav class="navbar navbar-custom container">
        <a class="navbar-brand" href="/">Fixity CRI Map.</a>
        <a href="/" class="btn btn-outline-light btn-sm">Back Home</a>
    </nav>

    <div class="container">
        <div class="row controls shadow-sm">
            <div class="col-md-4">
                <label class="form-label fw-bold">Select State</label>
                <select id="stateSelect" class="form-select">
                    <option value="">-- Select State --</option>
                    <option value="Maharashtra">Maharashtra</option>
                    <option value="Delhi">Delhi</option>
                </select>
            </div>
            <div class="col-md-4">
                <label class="form-label fw-bold">Select District</label>
                <select id="districtSelect" class="form-select" disabled>
                    <option value="">-- Select District --</option>
                </select>
            </div>
            <div class="col-md-4 d-flex align-items-end">
                <button class="btn btn-primary w-100" onclick="loadMapData()">Show Risk Index</button>
            </div>
        </div>

        <div id="map"></div>
    </div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script>
        const map = L.map('map').setView([20.5937, 78.9629], 5); // India Center
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);
        let layerGroup = L.layerGroup().addTo(map);

        // State-District Mapping
        const districtMap = {
            'Maharashtra': ['Pune', 'Mumbai'],
            'Delhi': ['Delhi']
        };

        const stateSelect = document.getElementById('stateSelect');
        const districtSelect = document.getElementById('districtSelect');

        stateSelect.addEventListener('change', function() {
            const state = this.value;
            districtSelect.innerHTML = '<option value="">-- Select District --</option>';
            if(state && districtMap[state]) {
                districtSelect.disabled = false;
                districtMap[state].forEach(dist => {
                    const opt = document.createElement('option');
                    opt.value = dist;
                    opt.textContent = dist;
                    districtSelect.appendChild(opt);
                });
            } else {
                districtSelect.disabled = true;
            }
        });

        async function loadMapData() {
            const district = districtSelect.value;
            if(!district) return alert("Please select a district");

            layerGroup.clearLayers(); // Clear old markers

            try {
                const res = await fetch(`/api/get_cri_data/${district}`);
                const data = await res.json();
                
                if(data.length === 0) { alert("No data for this district"); return; }

                // Determine bounds to zoom map
                let bounds = [];

                data.forEach(item => {
                    const color = item.color; // red, orange, green
                    
                    // Add Circle
                    const circle = L.circle([item.lat, item.lng], {
                        color: color,
                        fillColor: color,
                        fillOpacity: 0.5,
                        radius: 1500
                    }).addTo(layerGroup);

                    circle.bindPopup(`
                        <b>Block: ${item.block}</b><br>
                        CRI Score: ${item.cri}<br>
                        Risk: ${color.toUpperCase()}
                    `);
                    
                    bounds.push([item.lat, item.lng]);
                });

                map.fitBounds(bounds);

            } catch(e) {
                console.error(e);
                alert("Failed to load map data");
            }
        }
    </script>
</body>
</html>